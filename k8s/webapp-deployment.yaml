# Web Application Deployment
# Deploys multiple replicas of the Next.js Todo application with high availability

apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp-deployment
  labels:
    app: webapp
spec:
  replicas: 3                  # 3 replicas for high availability
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
        - name: webapp
          image: todo-app-web:v1
          imagePullPolicy: Never       # Use local image from Minikube's Docker
          ports:
            - containerPort: 3000
          env:
            - name: NODE_ENV
              value: "production"
            - name: MONGODB_URI
              # Connect to local MongoDB service inside Minikube cluster
              value: "mongodb://admin:todoapp123@mongodb-service:27017/tododb?authSource=admin"
            - name: NEXTAUTH_URL
              # Use localhost for server-side auth calls (pods call themselves)
              # External access via ngrok will work for browser requests
              value: "http://localhost:3000"
            - name: NEXTAUTH_SECRET
              value: "e0232e2e423724a78deeea88d021aee0d9ec43c3f39bb994e421582381c338fe"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          # Startup probe: Checks if app has started successfully
          startupProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30      # 150 seconds max startup time
          # Readiness probe: Determines if pod can receive traffic
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            periodSeconds: 10
            failureThreshold: 3
            successThreshold: 1
          # Liveness probe: Restarts pod if app becomes unresponsive
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            periodSeconds: 20
            failureThreshold: 3
